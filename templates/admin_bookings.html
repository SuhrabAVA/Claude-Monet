{% extends "base_admin.html" %}
{% block title %}Админ — Брони{% endblock %}

{% block content %}
<div class="admin-container">
  <div class="admin-header">
    <div>
      <h1 class="admin-title">Бронирования</h1>
      <p class="admin-sub">Быстрый просмотр всех броней. Поиск работает прямо на странице.</p>
    </div>
    <div class="admin-actions">
      <a class="btn" href="{{ url_for('index') }}">На сайт</a>
      <a class="btn btn--gold" href="{{ url_for('admin_menu_new', tab='item') }}">＋ Добавить меню</a>
    </div>
  </div>

  <div class="admin-card kpi">
    <div class="kpi__item">
      <div class="kpi__label">Всего броней</div>
      <div class="kpi__value">{{ bookings|length }}</div>
    </div>
    <div class="kpi__item">
      <div class="kpi__label">Сумма по всем (если есть корзина)</div>
      <div class="kpi__value gold">{{ money(bookings|sum(attribute='total_cents')) }}</div>
    </div>
    <div class="kpi__item">
      <div class="kpi__label">Быстрые действия</div>
      <div class="kpi__value" style="font-size:14px; font-weight:600; color:var(--muted); margin-top:8px;">
        Открыть бронь → клик по ID
      </div>
    </div>
  </div>

  <div class="admin-grid">
    <div class="admin-card">
      <div class="admin-card__hd">
        <div style="display:flex; flex-direction:column; gap:4px;">
          <div class="admin-card__title">Список броней</div>
          <div class="small">Фильтр: имя / почта / телефон / дата / время / сумма</div>
        </div>

        <div class="admin-tools" style="min-width:320px;">
          <input id="q" class="input" placeholder="Поиск… (например: 29.12, +33, Aлина, ₸)" />
        </div>
      </div>

      <div class="table-wrap">
        <table class="admin-table" id="bookingsTable">
          <thead>
            <tr>
              <th style="width:90px;">ID</th>
              <th>Клиент</th>
              <th>Контакты</th>
              <th>Дата · Время</th>
              <th style="width:90px;">Гостей</th>
              <th style="width:120px;">Сумма</th>
              <th style="width:160px;">Создано</th>
              <th style="width:110px;"></th>
            </tr>
          </thead>
          <tbody>
            {% for b in bookings %}
              <tr data-search="{{ (b.id|string) ~ ' ' ~ b.full_name ~ ' ' ~ (b.email or '') ~ ' ' ~ (b.phone or '') ~ ' ' ~ (b.date or '') ~ ' ' ~ (b.time or '') ~ ' ' ~ money(b.total_cents) ~ ' ' ~ (b.created_at or '') }}">
                <td><a href="{{ url_for('admin_booking_detail', reservation_id=b.id) }}">#{{ b.id }}</a></td>
                <td>
                  <div style="font-weight:800;">{{ b.full_name }}</div>
                  <div class="small">{{ b.comment or '' }}</div>
                </td>
                <td class="small">
                  <div>{{ b.email or '—' }}</div>
                  <div>{{ b.phone or '—' }}</div>
                </td>
                <td>
                  <div style="font-weight:700;">{{ b.date }}</div>
                  <div class="small">{{ b.time }}</div>
                </td>
                <td><span class="badge">{{ b.guests }}</span></td>
                <td><span class="badge badge--gold">{{ money(b.total_cents) }}</span></td>
                <td class="small">{{ b.created_at }}</td>
                <td style="text-align:right;">
                  <a class="btn" href="{{ url_for('admin_booking_detail', reservation_id=b.id) }}">Открыть</a>
                </td>
              </tr>
            {% endfor %}
            {% if not bookings %}
              <tr><td colspan="8" class="small">Пока нет бронирований.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="admin-row">
      <div class="small">Совет: если видишь пустую сумму — значит клиент бронировал стол без заказа блюд.</div>
      <a class="btn btn--gold btn--icon" href="{{ url_for('admin_menu_new', tab='item') }}" title="Добавить меню">+</a>
    </div>
  </div>
</div>

<script>
  (function(){
    const q = document.getElementById('q');
    const table = document.getElementById('bookingsTable');
    if(!q || !table) return;

    function norm(s){
      return (s || '').toString().toLowerCase().trim();
    }

    q.addEventListener('input', () => {
      const needle = norm(q.value);
      const rows = table.querySelectorAll('tbody tr');
      rows.forEach(tr => {
        const hay = norm(tr.getAttribute('data-search'));
        tr.style.display = (!needle || hay.includes(needle)) ? '' : 'none';
      });
    });
  })();
</script>
{% endblock %}
